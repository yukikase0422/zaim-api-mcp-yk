# 実施計画・実施状況: zaim_bulk_update ツール実装

## 1. 概要

### 1.1 目的
Zaim MCP機能拡張のフェーズ3として、`zaim_bulk_update`ツールを実装する。

### 1.2 指示内容
- 検索条件に合致するレコードに対して、指定したフィールドの値を一括で更新するツールを作成
- 安全策として件数確認を必須とする
- 文字列フィールドは完全置換と部分置換の両方をサポート

## 2. 要件詳細

### 2.1 安全策
- `expectedCount`パラメータ必須: 事前にzaim_advanced_searchで確認した件数を指定
- 実際の件数と一致しない場合はエラー
- `dryRun`オプションでプレビュー可能

### 2.2 検索条件と更新内容の整合性
- 更新しようとするフィールドが検索条件に含まれているか検証

### 2.3 更新可能フィールド
- カテゴリID
- ジャンルID
- 日付
- 金額
- 店舗名（place）
- 品目名（name）
- 口座ID（from_account_id / to_account_id）
- コメント（comment）

### 2.4 文字列フィールドの更新方式
- 完全置換: フィールドの値全体を新しい値に置き換える
- 部分置換: フィールド内の該当文字列を検索して置換/削除

## 3. 実施手順

### 3.1 既存コードの確認
- [x] 要件ファイルの確認
- [x] 型定義（advanced-search.ts）の確認
- [x] 既存ツール（money-update-tools.ts、advanced-search-tool.ts）の確認

### 3.2 型定義の追加
- [x] BulkUpdateInputSchemaは既に存在。ツール側でdateRangeとdryRunを拡張

### 3.3 ツール実装
- [x] bulk-update-tool.ts作成
- [x] 入力スキーマ定義（BulkUpdateToolInputSchema）
- [x] 安全策の実装（expectedCountとの件数比較）
- [x] 整合性チェック実装（validateUpdateFieldsInCriteria）
- [x] 更新ロジック実装（calculateUpdateBody、applyStringUpdate）

### 3.4 登録と統合
- [x] レジストリへの登録（registry.ts）
- [x] ツールハンドラーへの追加（tool-handler.ts）

### 3.5 テストとビルド
- [x] TypeScriptビルド確認 - 成功
- [x] 既存テストの実行 - 既存の問題以外は正常

## 4. 進行状況

### 4.1 ステップ実行状況
| ステップ | 状態 | 開始時刻 | 完了時刻 | 備考 |
|---------|------|---------|---------|------|
| 3.1 既存コード確認 | 完了 | 10:00 | 10:15 | 要件・型定義・既存ツール確認 |
| 3.2 型定義追加 | 完了 | - | - | ツール側でスキーマ拡張 |
| 3.3 ツール実装 | 完了 | 10:15 | 10:30 | bulk-update-tool.ts作成 |
| 3.4 登録と統合 | 完了 | 10:30 | 10:35 | レジストリ・ハンドラー更新 |
| 3.5 テストとビルド | 完了 | 10:35 | 10:40 | ビルド成功 |

### 4.2 発見事項・問題点
- 既存テスト（money-read-tools.test.ts）にmapping: 1パラメータ関連の失敗あり（今回の実装とは無関係）
- Zodのdefault()による型の不一致は、直接parse()を使用して解決

## 5. 成果物

### 5.1 作成ファイル
- `src/tools/advanced/bulk-update-tool.ts` - 一括更新ツール本体（約500行）

### 5.2 変更ファイル
- `src/tools/registry.ts` - ツール登録追加
- `src/core/tool-handler.ts` - 実行ケース追加

### 5.3 ツールの機能
- **ツール名**: `zaim_bulk_update`
- **機能**: 検索条件に合致するレコードを一括更新
- **安全策**: expectedCount必須、dryRunオプション
- **整合性チェック**: 更新フィールドが検索条件に含まれているか検証

## 6. 完了
全タスク完了。
