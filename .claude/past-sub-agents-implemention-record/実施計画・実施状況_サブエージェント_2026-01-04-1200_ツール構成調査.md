# 実施計画・実施状況: ツール構成調査

## 基本情報
- **作成日時**: 2026-01-04 12:00
- **タスク名**: ツール構成調査
- **プロジェクトディレクトリ**: d:/UserFolders/yukik/Desktop/_自作アプリ/4_Web・SNS連携/ZaimMCP

## 1. 指示内容

### 目的
ツール構成変更の計画策定のため、現在のコードベースのツール構成とヘルプドキュメントの構成を把握する。

### 調査内容
1. 現在のツール一覧
   - src/tools/配下のディレクトリ構造とファイル一覧
   - src/tools/registry.tsの内容
   - 各ツールの名前（zaim_で始まるツール名）

2. ヘルプドキュメントの構成
   - docs/ディレクトリの内容
   - ヘルプ関連ファイル
   - 現在3つ程度に分かれているとのことなので、それらを特定

3. ツール定義の構造
   - inputSchemaの構造
   - descriptionの記述方法
   - ツール実装のパターン

4. MCPサーバーのエントリーポイント
   - src/index.tsのツール登録部分

### 報告形式
1. ツール一覧表
2. ヘルプドキュメント一覧
3. ツール定義パターン
4. 統合に向けた考慮事項

## 2. 実施計画

### ステップ一覧
| # | タスク | 状態 |
|---|--------|------|
| 2.1 | src/tools/配下のディレクトリ構造確認 | 完了 |
| 2.2 | registry.tsの読み取り | 完了 |
| 2.3 | docs/ディレクトリとヘルプファイル確認 | 完了 |
| 2.4 | 代表的なツール定義ファイルの読み取り | 完了 |
| 2.5 | src/index.tsの確認 | 完了 |
| 2.6 | 調査結果のまとめと報告 | 完了 |

## 3. 進行状況

### 2026-01-04 12:00 - 開始
- 実施計画・実施状況ファイルを作成
- ToDoリストを設定

### 2026-01-04 12:05 - ディレクトリ構造確認完了
- src/tools/配下のディレクトリ構造を確認
- docs/ディレクトリのヘルプドキュメントを確認

### 2026-01-04 12:10 - ファイル読み取り完了
- registry.ts読み取り完了
- tool-help.ts読み取り完了
- ヘルプドキュメント3件読み取り完了
- 代表的なツール定義ファイル読み取り完了
- src/index.ts読み取り完了
- tool-handler.ts読み取り完了

### 2026-01-04 12:15 - 調査完了
- すべての調査項目を完了
- 報告書を作成

## 4. 調査結果報告

### 4.1 ツール一覧表

現在17個のツールが登録されています。

| # | ツール名 | カテゴリ | 主な機能 |
|---|----------|----------|----------|
| 1 | zaim_check_auth_status | auth | OAuth認証状態確認 |
| 2 | zaim_get_user_info | auth | ユーザー情報取得 |
| 3 | zaim_get_money_records | money | 家計簿データ取得（フィルタ・ページネーション対応） |
| 4 | zaim_create_payment | money | 支出データ作成 |
| 5 | zaim_create_income | money | 収入データ作成 |
| 6 | zaim_create_transfer | money | 振替データ作成 |
| 7 | zaim_update_money_record | money | データ更新 |
| 8 | zaim_delete_money_record | money | データ削除 |
| 9 | zaim_get_user_categories | master | ユーザー定義カテゴリ取得 |
| 10 | zaim_get_user_genres | master | ユーザー定義ジャンル取得 |
| 11 | zaim_get_user_accounts | master | ユーザー口座一覧取得 |
| 12 | zaim_get_default_categories | master | システムカテゴリ取得 |
| 13 | zaim_get_default_genres | master | システムジャンル取得 |
| 14 | zaim_get_currencies | master | 通貨一覧取得 |
| 15 | zaim_advanced_search | advanced | 複合条件検索（AND/OR対応） |
| 16 | zaim_bulk_update | advanced | 一括更新 |
| 17 | zaim_bulk_delete | advanced | 一括削除 |
| 18 | zaim_get_tool_help | help | ツールヘルプ取得 |

### 4.2 ヘルプドキュメント一覧

現在3つのヘルプドキュメントが存在し、`zaim_get_tool_help`ツールから参照されます。

| # | ファイル名 | 内容の概要 |
|---|------------|------------|
| 1 | docs/tools/zaim_advanced_search.md | 高度検索ツールの詳細ドキュメント（使用例6件、パラメータ説明、注意点） |
| 2 | docs/tools/zaim_bulk_update.md | 一括更新ツールの詳細ドキュメント（使用例4件、整合性チェック説明） |
| 3 | docs/tools/zaim_bulk_delete.md | 一括削除ツールの詳細ドキュメント（使用例4件、安全チェックリスト） |

**ヘルプ対応ツール（TOOLS_WITH_HELP定数）:**
- zaim_advanced_search
- zaim_bulk_update
- zaim_bulk_delete

### 4.3 ツール定義パターン

現在のツール定義は以下の構造を持っています。

**1. 入力スキーマ（Zod）**
```typescript
export const ToolInputSchema = z.object({
  param: z.string().describe('パラメータ説明'),
  optionalParam: z.boolean().optional().default(false)
}).strict();

export type ToolInput = z.infer<typeof ToolInputSchema>;
```

**2. ツール定義（MCP形式）**
```typescript
export const toolDefinition: ToolDefinition = {
  name: 'zaim_tool_name',
  description: 'ツールの機能説明',
  inputSchema: {
    type: 'object' as const,
    properties: {
      param: {
        type: 'string',
        description: 'パラメータ説明'
      }
    },
    required: ['param'],
    additionalProperties: false
  }
};
```

**3. 出力スキーマ（Zod）**
```typescript
export const ToolOutputSchema = z.object({
  success: z.boolean(),
  message: z.string(),
  // その他のフィールド
});

export type ToolOutput = z.infer<typeof ToolOutputSchema>;
```

**4. ツール実装関数**
```typescript
export async function toolFunction(
  input: ToolInput
): Promise<ToolOutput> {
  // 実装
}
```

### 4.4 ディレクトリ構造

```
src/tools/
├── CLAUDE.md            # ツール実装ガイドライン
├── registry.ts          # ツールレジストリ（全ツール登録）
├── auth/
│   └── user-tools.ts    # 認証・ユーザー情報ツール（2個）
├── money/
│   ├── money-read-tools.ts     # データ取得ツール（1個）
│   ├── money-write-tools.ts    # データ作成ツール（3個）
│   ├── money-update-tools.ts   # データ更新ツール（1個）
│   └── money-delete-tools.ts   # データ削除ツール（1個）
├── master/
│   └── master-data-tools.ts    # マスターデータツール（6個）
├── advanced/
│   ├── index.ts                # エクスポート
│   ├── advanced-search-tool.ts # 高度検索ツール
│   ├── bulk-update-tool.ts     # 一括更新ツール
│   └── bulk-delete-tool.ts     # 一括削除ツール
├── help/
│   └── tool-help.ts            # ヘルプツール
└── docs/
    └── examples/
        └── tool-implementation.md
```

### 4.5 MCPサーバーのエントリーポイント構造

**src/index.ts:**
- `ZaimMCPServer`クラスがMCPサーバーを構成
- `ListToolsRequestSchema`ハンドラーで`registeredTools`配列を返却
- `CallToolRequestSchema`ハンドラーで`ToolHandler.executeTool()`を呼び出し

**src/core/tool-handler.ts:**
- `ToolHandler`クラスがツール実行を担当
- `executeTool()`メソッドでswitchケースによりツールを振り分け
- 各ツールはZodスキーマでバリデーション後に実行

### 4.6 統合に向けた技術的考慮事項

**1. 変更が必要なファイル**
- `src/tools/registry.ts`: ツール登録の変更
- `src/core/tool-handler.ts`: switchケースの追加/変更
- `src/tools/help/tool-help.ts`: TOOLS_WITH_HELP定数の更新
- `docs/tools/*.md`: ヘルプドキュメントの統合/変更

**2. ヘルプドキュメントの統合パターン**
- 現在: ツール名と1対1でMarkdownファイルが存在
- 変更案: 新ツール用のヘルプドキュメントを作成し、TOOLS_WITH_HELPを更新

**3. ツール定義の統合パターン**
- 現在: 各ツールが個別にinputSchemaを持つ
- 変更案: 新ツールのinputSchemaに複数ツールの機能を統合

**4. 後方互換性の考慮**
- 既存ツール名を維持するか、完全に新規ツールに置き換えるか
- ヘルプツールのTOOLS_WITH_HELP定数の更新

**5. テストへの影響**
- 既存テストの変更が必要
- 新ツールのテスト作成が必要
