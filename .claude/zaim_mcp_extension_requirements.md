# Zaim MCP機能拡張 要件定義

## 概要

Zaim APIの制約を補完するため、MCP側で高度な検索・一括操作機能を実装する。

---

## 1. 検索機能の強化

### 1.1 複合条件検索

現在のAPIでは単一条件での検索しかできないため、MCP側で複数条件を組み合わせた検索を可能にする。

- **AND条件**: 複数の条件をすべて満たすレコードを抽出
- **OR条件**: いずれかの条件を満たすレコードを抽出
- **括弧によるグループ化**: 条件の優先順位を明示的に指定可能にする
  - 例: `(カテゴリ=食費 AND ジャンル=食料品) OR (カテゴリ=日用雑貨)`

### 1.2 検索条件として指定可能な項目

以下のすべての項目を検索条件として使用可能にする。

- 日付（範囲指定）
- カテゴリID
- ジャンルID
- モード（payment/income/transfer）
- 金額（範囲指定、完全一致）
- 店舗名（place）
- 品目名（name）
- 口座ID（from_account_id / to_account_id）
- コメント（comment）

### 1.3 文字列フィールドの検索方式

店舗名、品目名、コメントなどの文字列フィールドについては、以下の検索方式を提供する。

- **完全一致**: 値が完全に一致するもの
- **部分一致**: 指定した文字列を含むもの

### 1.4 API制限を超えた件数取得

API側に取得件数の制限がある場合、MCP側で自動的にページネーション処理を行い、指定された条件に合致するすべてのレコードを取得する。

- ユーザーが明示的に件数を制限している場合は、その件数に従う
- 制限がない場合は、条件に合致するすべてのレコードを取得してLLMに返す

### 1.5 検索結果の出力制御

検索結果の出力形式・量を柔軟に制御できるようにする。

#### 1.5.1 出力フィールドの選択

- **IDのみ**: レコードIDだけを出力
- **指定フィールドのみ**: ユーザーが指定した特定のフィールドのみを出力
- **全フィールド**: すべてのフィールドを出力

#### 1.5.2 出力量の制限

- **1件あたりの文字数制限**: 各レコードの出力が指定文字数を超えた場合はカットする
- **全体のレスポンス長制限**: 検索結果全体の文字数上限を設定可能

### 1.6 検索結果のソート順

ソート順は以下の固定パターンとし、ユーザーによる変更は不可とする。

1. **第1優先**: 日付（新しい順）
2. **第2優先**: 店舗名（place）順
3. **第3優先**: 品目名（name）順

---

## 2. 一括更新機能

### 2.1 基本仕様

検索条件に合致するレコードに対して、指定したフィールドの値を一括で更新する。

### 2.2 安全策

- **件数指定必須**: 一括更新を実行する前に、該当レコードの件数を入力しなければ実行できない
  - これにより、事前に検索を実行して対象を確認する手順が必須となる

### 2.3 検索条件と更新内容の関係

- 更新後の値で指定があるパラメータは、検索条件にも含める必要がある
  - 例: ジャンルをAからBに変更する場合、検索条件に「ジャンル=A」が含まれている必要がある

### 2.4 更新可能なフィールド

以下のすべてのフィールドを更新対象とする。

- カテゴリID
- ジャンルID
- 日付
- 金額
- 店舗名（place）
- 品目名（name）
- 口座ID（from_account_id / to_account_id）
- コメント（comment）

### 2.5 文字列フィールドの更新方式

店舗名、品目名、コメントなどの文字列フィールドについては、以下の更新方式を提供する。

- **完全置換**: フィールドの値全体を新しい値に置き換える
- **部分置換**: フィールド内の該当文字列を検索し、以下のいずれかを行う
  - 削除（空文字列で置換）
  - 他の文字列に置換

---

## 3. 一括削除機能

### 3.1 基本仕様

検索条件に合致するレコードを一括で削除する。

### 3.2 安全策

- **件数指定必須**: 一括削除を実行する前に、該当レコードの件数を入力しなければ実行できない
- 検索条件の指定が必須（条件なしでの全削除は不可）

---

## 参考

- Google Workspace MCPのバッチ処理実装を参考にする

---

## 未確定事項

（現時点で未確定事項なし）

---

## 変更履歴

- 2026-01-04: 初版作成
