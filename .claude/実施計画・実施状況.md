# Zaim MCP機能拡張 実施計画・実施状況

## ユーザー入力

Zaim MCP機能拡張の要件定義（`.claude/zaim_mcp_extension_requirements.md`）に従って実装を依頼。

### 目的・背景

Zaim APIの制約を補完するため、MCP側で高度な検索・一括操作機能を実装する。

### 実装する機能

1. 検索機能の強化（zaim_advanced_search）
2. 一括更新機能（zaim_bulk_update）
3. 一括削除機能（zaim_bulk_delete）

---

## 調査結果

### 既存のMoneyRecord型フィールド

id, mode, user_id, date, category_id, genre_id, account_id, amount, comment, active, created, currency_code, category, genre, account, from_account_id, to_account_id

### 不足フィールド

place（店舗名）、name（品目名）が型定義に不足 → 拡張が必要

### 既存検索の制限

- genre_id、account_id、金額範囲、店舗名、品目名、コメントでの検索不可
- 複合条件（AND/OR）不可
- ページネーション手動

---

## 実施計画

### フェーズ1: 共通基盤の実装
- [x] 型定義の拡張（place、nameフィールド追加）
- [x] 検索条件の型定義
- [x] 条件評価エンジン
- [x] ページネーションヘルパー

### フェーズ2: zaim_advanced_search実装
- [ ] ツール実装
- [ ] テスト作成

### フェーズ3: zaim_bulk_update実装
- [ ] ツール実装
- [ ] テスト作成

### フェーズ4: zaim_bulk_delete実装
- [ ] ツール実装
- [ ] テスト作成

### フェーズ5: 統合
- [ ] レジストリ登録
- [ ] ハンドラー更新
- [ ] 全体テスト

---

## 進行状況

- 2026-01-04: フェーズ1実装完了
  - 型定義の拡張（zaim-api.tsにplace、nameフィールド追加）
  - advanced-search.ts作成（検索条件・複合条件・出力制御・更新内容の型定義）
  - search-condition-evaluator.ts作成（条件評価エンジン）
  - pagination-helper.ts作成（ページネーションヘルパー）

---

## フェーズ1で作成/変更したファイル

### 変更ファイル
- `src/types/zaim-api.ts`: place、nameフィールドを追加

### 新規ファイル
- `src/types/advanced-search.ts`: 検索条件の型定義
- `src/utils/search-condition-evaluator.ts`: 検索条件評価エンジン
- `src/utils/pagination-helper.ts`: ページネーションヘルパー

---

## 次のフェーズで使用する主要な関数/型

### 型（advanced-search.ts）
- `SearchCondition`: 単一検索条件
- `CompositeCondition`: AND/OR複合条件
- `OutputControl`: 出力制御設定
- `UpdateFields`: 一括更新用フィールド

### 関数（search-condition-evaluator.ts）
- `evaluateCondition()`: 単一条件の評価
- `evaluateCompositeCondition()`: 複合条件の評価
- `filterRecords()`: レコードのフィルタリング

### 関数（pagination-helper.ts）
- `fetchAllRecords()`: 全件取得（自動ページネーション）
- `PaginationOptions`: ページネーションオプション

---
