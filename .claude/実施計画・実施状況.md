# Zaim API MCP Server セットアップ - 実施計画・実施状況

## 1. ユーザー入力

### 1.1 目的・背景
- Zaim API MCPサーバーをフォークし、ローカルのClaude Desktopで使用できるようにする
- 将来的にはGoogle CloudまたはVercelへのデプロイも検討（現時点ではローカル実行）

### 1.2 対象
- **フォーク元**: https://github.com/yone-k/zaim-api-mcp
- **フォーク先リポジトリ名**: `zaim-api-mcp-yk`
- **ローカルディレクトリ**: `d:\UserFolders\yukik\Desktop\_自作アプリ\4_Web・SNS連携\ZaimMCP`

### 1.3 Zaim認証情報（取得済み）
- Consumer Key: `a9991336c8b3721fddc73f87fe3bc78cfeac001c`
- Consumer Secret: `fff98f7b98a7f6f54e2587e58d0dba6ddc29616a`
- Access Token: **未取得**（OAuth認証フローで取得予定）
- Access Token Secret: **未取得**（OAuth認証フローで取得予定）

### 1.4 制約・禁止事項
- 認証情報（Secret類）はGitにコミットしない
- Node.js 22以上が必要
- Dockerは使用しない（ローカルNode.js実行）

---

## 2. 実施手順

### 2.1 Phase 1: リポジトリのフォークとクローン
| # | 内容 | 状態 | 担当 |
|---|------|------|------|
| 2.1.1 | GitHub上でフォーク作成（`zaim-api-mcp-yk`） | 未完了 | サブエージェント |
| 2.1.2 | ローカルにクローン | 未完了 | サブエージェント |
| 2.1.3 | Git初期設定確認 | 未完了 | サブエージェント |

### 2.2 Phase 2: 開発環境のセットアップ
| # | 内容 | 状態 | 担当 |
|---|------|------|------|
| 2.2.1 | Node.js 22+のインストール確認 | 未完了 | サブエージェント |
| 2.2.2 | npm install | 未完了 | サブエージェント |
| 2.2.3 | npm run build | 未完了 | サブエージェント |

### 2.3 Phase 3: OAuth認証フローの実行
| # | 内容 | 状態 | 担当 |
|---|------|------|------|
| 2.3.1 | 認証用スクリプト作成 | 未完了 | サブエージェント |
| 2.3.2 | リクエストトークン取得 | 未完了 | スクリプト実行 |
| 2.3.3 | ブラウザでZaim認証 | 未完了 | **ユーザー** |
| 2.3.4 | アクセストークン取得 | 未完了 | スクリプト実行 |

### 2.4 Phase 4: 環境変数の設定
| # | 内容 | 状態 | 担当 |
|---|------|------|------|
| 2.4.1 | .envファイル作成（gitignore対応） | 未完了 | サブエージェント |

### 2.5 Phase 5: Claude Desktop設定
| # | 内容 | 状態 | 担当 |
|---|------|------|------|
| 2.5.1 | claude_desktop_config.json更新 | 未完了 | サブエージェント |

### 2.6 Phase 6: 動作確認
| # | 内容 | 状態 | 担当 |
|---|------|------|------|
| 2.6.1 | Claude Desktop再起動 | 未完了 | **ユーザー** |
| 2.6.2 | 認証状態確認 | 未完了 | 動作テスト |
| 2.6.3 | ユーザー情報取得テスト | 未完了 | 動作テスト |

---

## 3. 進行状況ログ

### 2026-01-03
- 計画策定完了
- 実施開始
- **Phase 1 完了**: フォーク・クローン成功
  - リポジトリURL: https://github.com/yukikase0422/zaim-api-mcp-yk
- **Phase 2 完了**: 環境構築成功
  - Node.js: v22.16.0
  - npm install: 成功（脆弱性警告あり、開発環境では許容）
  - npm run build: 成功（出力: dist/）
- **Phase 3 完了**: OAuth認証フロー
  - スクリプト作成完了: scripts/oauth-setup.ts
  - Access Token取得成功
- **Phase 4 完了**: 環境変数設定
  - .envファイル作成完了
- **Phase 5 完了**: Claude Desktop設定
  - claude_desktop_config.json更新完了（既存設定を保持）
- **Phase 6 開始**: 動作確認
  - **待機中**: Claude Desktop再起動

---

## 4. エージェント委任詳細

### 4.1 Phase 1-2 委任（環境構築）
- **委任先**: empty-agent
- **指示ファイル**: 本ファイルのセクション2.1, 2.2を参照
- **並列呼び出し数**: 1

### 4.2 Phase 3 委任（OAuth認証）
- **委任先**: empty-agent
- **指示内容**: OAuth 1.0a認証スクリプト作成・実行
- **ユーザー操作が必要なタイミング**: 2.3.3（ブラウザ認証）

---

## 5. 発見事項・問題点

### 2026-01-03 エラー発生
- **問題**: Claude DesktopでMCPサーバー `zaim-api` が「failed」状態
- **エラーメッセージ**: 「Server disconnected」
- **対応**: セクション6でエラー原因調査を実施

---

## 6. エラー原因調査（2026-01-03）

### 6.1 調査目的
Claude DesktopでMCPサーバーが正常に動作しない原因を特定し、修正可能な状態にする。

### 6.2 調査対象
- ログファイル: `C:\Users\yukik\AppData\Roaming\Claude\logs`
- ビルド成果物: `dist/index.js`
- 依存関係: `node_modules`
- MCPサーバーの直接起動テスト

### 6.3 調査手順
| # | 内容 | 状態 | 担当 |
|---|------|------|------|
| 6.3.1 | ログファイルの確認・エラー内容の特定 | 未完了 | problem-investigation |
| 6.3.2 | MCPサーバーの直接起動テスト | 未完了 | problem-investigation |
| 6.3.3 | ビルド成果物の検証 | 未完了 | problem-investigation |
| 6.3.4 | 依存関係の確認 | 未完了 | problem-investigation |
| 6.3.5 | 原因特定と修正方法の提案 | 未完了 | problem-investigation |

### 6.4 環境変数（テスト用）
```
ZAIM_CONSUMER_KEY=a9991336c8b3721fddc73f87fe3bc78cfeac001c
ZAIM_CONSUMER_SECRET=fff98f7b98a7f6f54e2587e58d0dba6ddc29616a
ZAIM_ACCESS_TOKEN=ry7Y6ykDgc8VRkxPtiARTpXOxH2dqKVlSAzNu7whGljIakfRxiKchdDvMyYiJCJGc0XQ
ZAIM_ACCESS_TOKEN_SECRET=njjKpGgDgRQTiJtpPLVKCGyzlR5NO5NbMAnNRr90zRkQujj3KzyOa18BiW7LfSKGlKBaWEvx7fEUXh
```

### 6.5 進行状況
- 実施計画更新完了
- problem-investigation スキル呼び出し準備中

---

## 7. src/index.ts修正タスク（2026-01-03）

### 7.1 ユーザー入力

**目的・背景**:
src/index.tsの起動ロジックを修正し、条件式（import.meta.url === `file://${process.argv[1]}`）を削除してmain()を直接実行するようにする。

**対象ファイル・ディレクトリ**:
- `src/index.ts` (77-82行目付近)

**操作内容**:
1. src/index.tsの77-82行目付近の以下のコードを修正
   - 修正前: if文で条件チェックしてからmain()実行
   - 修正後: main()を直接実行
2. npm run buildでビルド
3. ビルド成功を確認

**手順**:
1. src/index.tsを読み込み、該当箇所（77-82行目付近）を確認
2. if (import.meta.url === `file://${process.argv[1]}`) の条件式を削除
3. main().catch((error) => {...}) を直接実行する形に修正
4. npm run build を実行
5. ビルドが成功することを確認
6. 修正前後のコード、ビルド結果、問題点を報告

**制約・禁止事項**:
- 修正箇所は77-82行目付近のみ
- 他の箇所は変更しない
- ビルドが成功することを必須条件とする

### 7.2 実施手順

| # | 内容 | 状態 | 担当 |
|---|------|------|------|
| 7.2.1 | 実施計画記録 | 完了 | メインエージェント |
| 7.2.2 | agents/フォルダの確認 | 未実施 | メインエージェント |
| 7.2.3 | サブエージェントへの委任指示作成 | 未実施 | メインエージェント |
| 7.2.4 | サブエージェント呼び出し | 未実施 | メインエージェント |
| 7.2.5 | 結果確認と報告 | 未実施 | メインエージェント |

### 7.3 エージェント委任詳細

- **委任先**: （agents/フォルダ確認後に決定）
- **指示内容**: セクション7.1の手順を実行
- **並列呼び出し数**: 1

### 7.4 進行状況

- [2026-01-03 21:18] 実施計画記録完了
- [2026-01-03 21:18] agents/フォルダ確認を開始
